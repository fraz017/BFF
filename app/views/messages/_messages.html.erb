<% current_user.chat_room.messages.last(10).each do |message| %>
<!-- Message. Default to the left -->
  <%if message.sender_id != current_user.id %>
    <div class="direct-chat-msg">
      <div class="direct-chat-info clearfix">
        <span class="direct-chat-name pull-left">BFF</span>
        <span class="direct-chat-timestamp pull-right"><%= message.created_at.strftime("%d %b %l:%M %P ") %></span>
      </div><!-- /.direct-chat-info -->
      <div class="direct-chat-text reciever-message">
        <%= message.content %>
        <% if message.category.present? %>
          <span class="label label-warning"><%= message.category.name %></span>
        <% end %>
      </div><!-- /.direct-chat-text -->
      <div class="clearfix"></div>
      <%
        reply = message.replies.where(sender_id: current_user.id)
        if reply.present?
      %>
        <div class="direct-chat-info clearfix">
          <span class="direct-chat-name pull-left">Replied By You</span>
          <span class="direct-chat-timestamp pull-right"><%= reply.first.created_at.strftime("%d %b %l:%M %P ") %></span>
        </div><!-- /.direct-chat-info -->
        <div class="direct-chat-text reciever-message reply-sender">
          <%= reply.first.content %>
        </div>
      <%else%>
        <div class="direct-chat-text reciever-message">
          <a href="javascript:void(0)" id="<%= message.id %>-<%= current_user.id %>" class="reply-btn">Reply to this message</a>
          <a href="javascript:void(0)" id="<%= message.id %>-<%= current_user.id %>-cancel" class="cancel-btn hidden">Cancel</a>
          <div class="row reply-box hidden" id="reply-<%= message.id %>-<%= current_user.id %>">
            <%= form_tag("/reply", method: 'post', :remote => true, class: "form-horizontal") do %>
              <div class="col-xs-8">
                <input type="text" name="reply" id="reply" placeholder="Type Message ..." class="form-control">
                <input type="hidden" name="message_id" value="<%= message.id %>">
              </div>
              <div class="col-xs-2">
                <button type="submit" class="btn btn-primary btn-flat">Send</button>
              </div>
            <% end %>
          </div> 
        </div><!-- /.direct-chat-text -->
      <%end%>
    </div><!-- /.direct-chat-msg -->
  <%else%>
    <!-- Message to the right -->
    <div class="direct-chat-msg right">
      <div class="direct-chat-info clearfix">
        <span class="direct-chat-name pull-right">Me</span>
        <span class="direct-chat-timestamp pull-left"><%= message.created_at.strftime("%d %b %l:%M %P ") %></span>
      </div><!-- /.direct-chat-info -->
      <div class="direct-chat-text sender-message clearfix">
        <%= message.content %>
        <% if message.content.include?("?") %>
          <div class="cat-question" id="<%= message.id %>">
            <% if message.category.present? %>
              <span class="label label-warning"><%= message.category.name %></span>
            <% else %>
              <label>Select Category:</label>
              <select name="category" class="cat-select" id="<%= message.id %>">
                <option value="music">Music</option>
                <option value="sports">Sports</option>
                <option value="entertainment">Entertainment</option>
                <option value="romance">Romance</option>
                <option value="fashion">Fashion</option>
                <option value="health_and_fitness">Health & Fitness</option>
                <option value="other">Other</option>
              </select>
            <% end %>  
          </div>
        <% end %>
      </div><!-- /.direct-chat-text -->
      <% if message.replies.present? %>
          <div class="msg-replies">
            <label>Top 3 replies:</label>
            <ul>
              <% message.replies.order("score desc").first(3).each do |msg| %>
                <li>
                  <span><%= msg.content %></span>
                </li>
              <% end %>  
            </ul>
          </div>
        <% end %>
      <%
        reply = message.replies.order("score desc")
        if reply.present?
      %>
        <div class="clearfix"></div>
        <div class="direct-chat-info clearfix">
          <span class="direct-chat-name pull-left">Replied By BFF</span>
          <span class="direct-chat-timestamp pull-right"><%= reply.first.created_at.strftime("%d %b %l:%M %P ") %></span>
        </div><!-- /.direct-chat-info -->
        <div class="direct-chat-text sender-message reply-reciever">
          <%= reply.first.content %>
        </div>
      <%end%>
    </div><!-- /.direct-chat-msg -->
  <%end%>
<%end%>

<script type="text/javascript">
  $(".direct-chat-messages").animate({ scrollTop: $(".direct-chat-messages")[0].scrollHeight}, 1000);
  $(".reply-btn").click(function(){
    var id = $(this).attr("id");
    $("#reply-"+id).removeClass("hidden");
    $("#"+id+"-cancel").removeClass("hidden");
    $("#"+id).addClass("hidden");
  })
  $(".cancel-btn").click(function(){
    var id = $(this).attr("id").split("-cancel")[0];
    $("#reply-"+id).addClass("hidden");
    $("#"+id+"-cancel").addClass("hidden");
    $(".reply-btn#"+id).removeClass("hidden");
  });
  $(".cat-select").change(function(){
    var value = $(this).val();
    var message_id = $(this).attr("id");
    $.ajax({
      method: "POST",
      url: "/save_category",
      data: { category: value, message_id: message_id }
    })
    .done(function( msg ) {
      $(".cat-question#"+message_id).html('<span class="label label-warning">'+ value +'</span>');
    });
  });
</script>
<style type="text/css">
.msg-replies{
  background-color: darkgray;
  color: #fff;
  padding: 5px;
  width: 100%;
  height: auto;
  border-radius: 5px;
  display: inline-block;
  margin-top: 5px;
}
</style>